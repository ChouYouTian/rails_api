<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <link href="./main.css" rel="stylesheet">
    </head>
    <body>

        <main class="container-fluid">
            
            <div id="login" class="row  justify-content-center" >
                <!-- <div class="col"></div> -->
                <div class="main col col-md-5 col-xl-4  text-center" >
                    
                        <h1>Login</h1>
                        <div class="form-floating">
                            <input id="loginEmail" type="email" class="form-control"  placeholder="Password">
                            <label for="loginEmail">Email</label>
                        </div>
                        <div class="form-floating">
                            <input id="loginPassword" type="password" class="form-control"  placeholder="Password">
                            <label for="loginPassword">Password</label>
                        </div>
                        
                        <button id="btnlogin" class="mt-2 w-50 btn btn-lg btn-primary" onclick="login()">login</button>
                        <div class="mt-3">
                            <a href="" onclick="signupPage()">Signup account</a>
                        </div>
                    
                </div>
                <!-- <div class="col"></div> -->
            </div>

            
            <div id="signup" class="row justify-content-center" style="display: none;" >
               
                <div class="main col col-md-5 col-xl-4 text-center">
                    
                        <h1>Signup</h1>
                        <div class="form-floating">
                            <input id="signupName" type="text" class="form-control"  placeholder="name@example.com">
                            <label for="signupName">Name</label>
                        </div>
                        <div class="form-floating">
                            <input id="signupEmail" type="email" class="form-control"  placeholder="Password">
                            <label for="signupEmail">Email</label>
                        </div>
                        <div class="form-floating">
                            <input id="signupPassword" type="password" class="form-control"  placeholder="Password">
                            <label for="signupPassword">Password</label>
                        </div>
                        <div class="form-floating">
                            <input id="signupCpassword" type="password" class="form-control"  placeholder="Password">
                            <label for="signupCpassword">Confirm Password</label>
                        </div>
                        
                        <button id="btnsignup" class="mt-2 w-50 btn btn-lg btn-light" onclick="signup()">Signup</button>
                        <div class="mt-3">
                            <a href="" onclick="loginPage()">Login</a>
                        </div>
                    
                </div>
              
            </div>


            <div id="mainpage" class="" style="display: none;">
                <div class="row  justify-content-center">
                    <h1 class="col-sm-6" id="hello">Hello,user</h1>
                    <button class="col-sm-2 btn btn-lg btn-danger" onclick="deleteUser()">Delete User</button>

                    <button class="col-sm-2 btn btn-lg btn-primary" onclick="logout()">Logout</button>
                </div>
                
                <!-- myproduct -->
                <div class="container my-5 py-3 border rounded-3">
                    <h4>My product</h4>
                    <table id="myproducttable" class="table table-hover">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Product name</th>
                                <th>price</th>
                                <th>quantity</th>
                                <th></th>
                                <th>tags</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                    
                    <!-- create product -->
                    <div class="my-3">
                        <h4>Create product</h4>
                        <div class="input-group">
                            
                            <span class="input-group-text ">Product name</span>
                            <input type="text" name="name" class="form-control  ">
                            
                            <span class="input-group-text ">Price</span>
                            <input type="number" name="price" min="0" max="500" class="form-control ">
                            
                            <span class="input-group-text ">Quantity</span>
                            <input type="number"  name="quantity" min="0" max="500" class="form-control">
                            
                            <button class="btn btn-primary" onclick="createProduct(this)">create</button>
                        </div>
                    </div>
                </div>

                <!-- coupons -->
                <div class="container my-5 py-3 border rounded-3">
                    <h4>Coupons</h4>
                    <table id="coupontable" class="table table-hover">
                        <thead>
                            <tr>
                                <th>id</th>
                                <th>name</th>
                                <th>quantity</th>
                                <th>description</th>
                                <th>start</th>
                                <th>end</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button onclick="$('#newCoupon').toggle(100)">create coupon</button>
                    <div class="mt-3" id="newCoupon" >
                        <form action="/coupon/test" method="post">

                            <div class="input-group mb-3">
                                <input name="name" type="text" class="form-control" placeholder="Coupon name ex.NewYear30">
                                <button class="btn btn-outline-danger" type="button">Check name</button>
                            </div>
                            <select name="type" class="form-select form-select-lg mb-3">
                                <option selected>Select type</option>
                                <option value="price">Price</option>
                                <option value="percentage">Percentage</option>
                            </select>
                            <input name="quantity" class="form-control mb-3" type="number" min=0 placeholder="Quantity">
                            <input name="description" class="form-control mb-3" type="text" placeholder="Description">
                            <input name="minmum" class="form-control mb-3" type="number" min=0 placeholder="Minmum">
                            <input name="ordinal" class="form-control mb-3" type="number" min=0 placeholder="Ordinal">
                            <input name="amount" class="form-control mb-3" type="number" min=0 max=100 placeholder="Discount Amount">
                            
                            <fieldset class="border p-2 mb-3">
                                <legend class="w-auto">Conditions:</legend>
                                <div class="input-group mb-3">
                                    <input id="selectedProducts" class="form-control" type="text" placeholder="ProductID">
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#productModal">Find products</button>
                                </div>
                                <label class="mb-3">Or</label>
                                <input name="tags" class="form-control mb-3" type="text" placeholder="Tag">
                            </fieldset>


                            <input name="start_time" class="form-control mb-3" type="datetime-local" >
                            <input name="end_time" class="form-control" type="datetime-local" >
                            <input type="submit" value="Create"> 
                            
                        </form>
                    </div>
                    
                </div>
                    
                <!-- products -->
                <div class="container my-5 py-3 border rounded-3">
                    <h4>Products</h4>
                    <select id="selectProviders" class="form-select w-25" onchange="selectProvider(this)">
                        <option selected>Select provider</option>
                    </select>
                    
                    <table id="producttable" class="table table-hover ">
                        <thead>
                            <tr>
                                <th>Product name</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Amount</th>
                                <th>Tags</th>
                                <th> </th>
                                <!-- <th></th> -->
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                    </table>
                </div>


                <!-- cart -->
                <div class="container my-5 py-3 border rounded-3"> 
                    <h4>My cart</h4>
                    <table id="carttable" class="table table-hover" style="text-align:center">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Product name</th>
                                <th>amount</th>
                                <th>price</th>
                                <th>quantity</th>
                                <th>total price</th>
                                <th> </th>
                                <th>message</th>
                                <th>state</th>
                                
                            </tr>
                        </thead>
                        <tbody >

                        </tbody>
                        <tfoot style="text-align:center">
                            <tr>
                              <td>Sum</td>
                              <td id="total">$0</td>
                              <td></td>
                              <td></td>
                              <td></td>
                              <td></td>
                              <td><button class="btn btn-primary" onclick="createTrade()">結帳</button></td>
                            </tr>
                        </tfoot> 
                    </table>
                </div>
            
                <!-- mytrade -->
                <div class="container my-5 py-3 border rounded-3">
                    <h4>My trade</h4>
                    <table id="tradetable" class="table table-hover" style="text-align:center">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Trade id</th>
                                <th>detail</th>
                                <th>total price</th>
                                <th>state</th>
                                
                            </tr>
                        </thead>
                        <tbody >

                        </tbody>

                    </table>
                </div>
            
            
            </div>

            <!-- Tag Modal -->
            <div class="modal" id="tagModal">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                
                        <!-- Modal Header -->
                        <div class="modal-header">
                        <h4 class="modal-title">Modal Heading</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                
                        <!-- Modal body -->
                        <div class="modal-body">
                            <div class="form-floating">
                                <input type="text" id="modalInput" class="form-control" placeholder="tag">
                                <label for="modalInput">Add Tag</label>
                            </div>
                            <p>ex. Cookies</p>
                        </div>
                
                        <!-- Modal footer -->
                        <div class="modal-footer">
                            <button id="modalAdd" class="btn btn-primary" data-bs-dismiss="modal" onclick="addTag(this)">Add</button>
                            <button id="modalDelete" class="btn btn-danger" data-bs-dismiss="modal" onclick="deleteTag(this)">Delete</button>
                        </div>
                
                    </div>
                </div>
            </div>

            <!-- Product Modal -->
            <div class="modal" id="productModal">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                
                        <!-- Modal Header -->
                        <div class="modal-header">
                        <h4 class="modal-title">Select Products</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                
                        <!-- Modal body -->
                        <div class="modal-body" id="selectProduct">
                            <table class="table table-hover " >
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Price</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
                                </tbody>
                            </table>

                        </div>
                
                        <!-- Modal footer -->
                        <div class="modal-footer">
                            <button  class="btn btn-primary" data-bs-dismiss="modal" onclick="selectCouponProducts()">Select</button>
                        </div>
                
                    </div>
                </div>
            </div>
            
        </main>

        <script>  //init
            $(function() {
                refresh()
            });
            function refresh(){
                
                if (sessionStorage.getItem("login")=="true"){
                    $("#login").hide()
                    $("#mainpage").show()
                    $('#hello').text('Hello '+sessionStorage.getItem("user_name"))
                    myproducts();
                    setProviders();
                    setCarts();
                    setTrades();
                }
                else{
                    sessionStorage.setItem("login","false")
                    $("#mainpage").hide()
                    
                    if (sessionStorage.getItem("page")=="signup"){
                        $("#login").hide();
                        $("#signup").show();
                    }
                    else{
                        $("#signup").hide();
                        $("#login").show();

                    }
                }
            }

        </script>
       
        <script> //util funtions
        
            function postToApi(url,data,successfun=()=>{},failfun=()=>{}){
                callback=false
                $.ajax({    
                    async:false,
                    url: url,
                    data: JSON.stringify(data),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        if (returnData['code']==0){
                            successfun();
                            callback=true
                        }
                        else if (returnData['code']==8){
                            sessionStorage.setItem("login","false");
                            alert(returnData['msg']);
                            refresh()
                        }
                        else{
                            alert(returnData['msg']);
                            failfun();
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
                return callback
            }
        
            function getFromApi(url){
                var callback=""
                $.ajax({ 
                    async:false,
                    url: url ,
                    type: "GET",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        if (returnData['code']==0){
                            callback=returnData
                        }
                        else if (returnData['code']==8){
                            sessionStorage.setItem("login","false");
                            alert(returnData['msg']);
                            refresh()
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
                return callback
            }
        
            
            function getProducts(id){
                var products
                $.ajax({ 
                    async:false,
                    url: "/product/products?id="+id,
                    type: "GET",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        if (returnData['code']==0){
                            products=returnData['products'];
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
                return products
            }
        </script>
        <script> //modal
            var tagModal = document.getElementById('tagModal')
            
            tagModal.addEventListener('show.bs.modal', function (event) {
      
                var button = event.relatedTarget
                var parent=button.parentNode.parentNode
                productId=parent.querySelector('td[name="id"]').dataset.id

                $("#modalAdd").attr("data-id",productId)
                $("#modalDelete").attr("data-id",productId)

            })

            var productModal = document.getElementById('productModal')

            productModal.addEventListener('show.bs.modal', function (event) {
                products=getProducts(sessionStorage.getItem('user_id'))
                table = document.getElementById("productModal").querySelector('tbody');
                $('#productModal tbody tr').each(function(){
                    $(this).remove()
                })

                ids=$('#selectedProducts').val().split( /\s*/)
                console.log(ids)
                

                products.forEach(product=>{
                    var row = table.insertRow(-1);
                    var selectbtn = row.insertCell(0);
                    var ID = row.insertCell(1);
                    var name = row.insertCell(2);
                    var price = row.insertCell(3);
                    var quantity = row.insertCell(4);

                    var checkbox= document.createElement("input");
                    checkbox.type='checkbox'
                    checkbox.setAttribute('data-id',product['id'])
                    if (ids.includes(product['id'].toString())){
                        checkbox.checked=true
                    }
                    
                    selectbtn.appendChild(checkbox)
                    
                    ID.innerHTML=product["id"]
                    name.innerHTML=product['name']
                    price.innerHTML=product['price']
                    quantity.innerHTML=product['quantity']

                })
                
                

            })
        </script>
        <script> //tags
            function addTag(element){
                tag=$("#modalInput").val()
                productId=element.dataset.id
                postToApi("/product/addTag",{"product":productId,"tag":tag},()=>{myproducts()})
            }

            function deleteTag(element){
                tag=$("#modalInput").val()
                productId=element.dataset.id
                postToApi("/product/deleteTag",{"product":productId,"tag":tag},()=>{myproducts()})
            }
        </script>
        <script> //product funtions
            function myproducts(){
                products=getProducts(sessionStorage.getItem('user_id'))
                $('#myproducttable tbody tr').each(function(){
                        $(this).remove()
                    })
                var table = document.getElementById("myproducttable").querySelector('tbody');

                products.forEach(product => {
                    var row = table.insertRow(-1);
                    var deletebtn = row.insertCell(0);
                    var name = row.insertCell(1);
                    var price = row.insertCell(2);
                    var quantity = row.insertCell(3);
                    var btns = row.insertCell(4);
                    var tags=row.insertCell(5);
                    var tagbtn = row.insertCell(6);
                    var id = row.insertCell(7);

                    name.innerHTML = '<input type="text" name="name" readonly value='+ product['name']+ '>';
                    price.innerHTML = '<input type="number" name="price" min="0" max="5000" readonly value='+product['price'] +'>';
                    quantity.innerHTML = '<input type="number" name="quantity" min="0" max="500" readonly value='+product['quantity'] +'>';

                    tagsStr=""
                    product['tags'].forEach(tag=>{
                        tagsStr+="#"+tag["name"]+" "
                    })
                    tags.innerHTML=tagsStr

                    tagbtn.innerHTML='<button  class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#tagModal">Edit tag</button>'

                    deletebtn.innerHTML = '<button name="delete" class="btn btn-danger" onclick="deleteProduct(this)">delete</button>'
                    btns.innerHTML = '<button name="save" class="btn btn-secondary" onclick="saveProduct(this)" disabled >save</button>'+'<button name="edit" class="btn btn-primary"  onclick="editProduct(this)" >edit</button>'
                 
                    $(id).hide();
                    $(id).attr('name','id')
                    $(id).attr('data-id',product['id'])
                    $(id).attr('data-edit','false')
                    
                });

            }
            function getSibling(element){
                parent=element.parentNode.parentNode
                pname=parent.querySelector('input[name="name"]') //pname product name
                quantity= parent.querySelector('input[name="quantity"]')
                price=parent.querySelector('input[name="price"]')
                id=parent.querySelector('td[name="id"]')
                return [pname,quantity,price,id]
            }

            function saveProduct(element){

                [pname,quantity,price,id]=getSibling(element) //pname product name
                editbtn=element.nextElementSibling;

                product={}
                product["id"]=id.dataset.id
                product["name"]=pname.value
                product["quantity"]=quantity.value
                product["price"]=price.value

                postToApi( "/product/updateProducts",{'products':[product]},
                ()=>{
                    alert("Saved");
                    editbtn.disabled=false
                    element.disabled=true

                    pname.readOnly=true
                    quantity.readOnly=true
                    price.readOnly=true
                },
                ()=>{
                    myproducts()
                }
                )
            }

            function editProduct(element){
                [pname,quantity,price,id]=getSibling(element) //pname product name
                savebtn=element.previousElementSibling;

                savebtn.disabled=false
                element.disabled=true

                pname.readOnly=false
                quantity.readOnly=false
                price.readOnly=false
            }


            function createProduct(element){
                parent=element.parentNode
                pname=parent.querySelector('input[name="name"]') //product name
                price=parent.querySelector('input[name="price"]')
                quantity=parent.querySelector('input[name="quantity"]')

                jdata={}
                product={}
                product["name"]=pname.value
                product["quantity"]=quantity.value 
                product["price"]=price.value

                jdata['products']=[product]

                postToApi("/product/addProducts",jdata,
                ()=>{
                    alert("Saved");
                    myproducts();
                    pname.value="";
                    quantity.value =0;
                    price.value=0;
                })

                
                
            }
        
            function deleteProduct(element){

                
                [pname,quantity,price,id]=getSibling(element)

                if (confirm("Sure to delete "+pname.value+"?")){
                    jdata={"products":[id.dataset.id]}
    
                    parent=element.parentNode.parentNode;
                    postToApi('/product/deleteProducts',jdata,
                    ()=>{
                        parent.remove();
                    })
                }

            }
        
        </script>

        <script> //cart funtions
            function setCarts(){
                carts=getFromApi('/cart')["carts"]

                var table = document.getElementById("carttable").querySelector('tbody');
                
                $("#carttable tbody tr").each(function(){
                        $(this).remove()
                })

                carts.forEach(cart=>{
                    var row = table.insertRow(-1);
    
                    var selectbox = row.insertCell(0);
                    var name = row.insertCell(1);
                    var amount = row.insertCell(2);
                    var price = row.insertCell(3);
                    var quantity = row.insertCell(4);
                    var total_price = row.insertCell(5);
                    var deletebtn = row.insertCell(6);
                    var msg = row.insertCell(7);
                    var state = row.insertCell(8);
                    var id = row.insertCell(9);

                    name.innerHTML = cart['name'];
                    amount.innerHTML ='<input type="number" name="amount" onchange="changeCartAmount(this)" min="1"'+' value='+cart['amount'] + '>';;
                    price.innerHTML = cart['price'];
                    price.setAttribute('name','price')
                    quantity.innerHTML = cart['quantity'];
                    quantity.setAttribute('name','quantity')
                    total_price.innerHTML=cart['total_price']
                    total_price.setAttribute('name','total_price')
                    deletebtn.innerHTML= '<button class="btn btn-danger" onclick="deleteCart(this)">delete</button>'
                    msg.innerHTML= cart['msg']
                    msg.setAttribute('name','msg')
                    state.innerHTML=cart['state']

                    selectbox.innerHTML='<input name="select" type="checkbox" onclick="setCartTotalPrice()">'

                    
                    if(cart['state']=="lack"){
                        selectbox.querySelector("input").disabled=true
                    }
                    else if(cart['state']=="disable"){
                        selectbox.querySelector("input").disabled=true
                        amount.innerHTML=cart["amount"]
                    }
                    else if( cart['state']=="intrade" || cart['state']=="cancel" ){
                        selectbox.querySelector("input").disabled=true
                        amount.innerHTML=cart["amount"]
                        deletebtn.querySelector("button").disabled=true
                        deletebtn.querySelector("button").classList.remove('btn-danger')
                        deletebtn.querySelector("button").classList.add('btn-outline-danger')
                    }
            
                    $(id).hide();
                    $(id).attr('name','id')
                    $(id).attr('data-id',cart['id'])
                    
                })
            }

            function deleteCart(element){
                parent=element.parentNode.parentNode

                id=parent.querySelector('td[name="id"]').dataset.id
                jdata=[id]
                postToApi('cart/deleteCarts',{"carts":jdata},()=>{alert(id+'deleted');parent.remove();});

            }

            function addToCart(element){
                parent=element.parentNode.parentNode
                id=parent.querySelector('td[name="id"]').dataset.id

                amount=parseInt(parent.querySelector('input[name="amount"]').value)

                if(amount==0){
                    alert('Amount can\'t be 0')
                }
                else{
                    postToApi('/cart/addToCart',{"product":{"id":id,"amount":amount}},
                        ()=>{alert("added to cart");
                             setCarts()   
                            })
                }


            }

            function changeCartAmount(element){
                
                parent=element.parentNode.parentNode
                id=parent.querySelector('td[name="id"')
                price=parent.querySelector('td[name="price"]')
                total_price=parent.querySelector('td[name="total_price"]')
                select=parent.querySelector('input[name="select"]')
                quantity=parent.querySelector('td[name="quantity"]')
                msg=parent.querySelector('td[name="msg"]')
                if(element.value<=parseInt(quantity.innerHTML)){
                    select.removeAttribute('disabled')
                    msg.innerHTML=""
                }
                else if(element.value>parseInt(quantity.innerHTML)){
                    select.disabled=true
                    msg.innerHTML="數量不足"
                    
                }

                total_price.innerHTML=parseInt(price.innerHTML)*element.value

                postToApi('cart/updateCarts',{"carts":[{"id":id.dataset.id,"amount":element.value,"total_price":total_price.innerHTML}]},
                ()=>{setCartTotalPrice()})

            }
        
            function setCartTotalPrice(){
                total_price=0
                table=$('#carttable tbody tr')
                
                
                $(table).each(function(){
                    box=this.querySelector('td input[name="select"]')
                    tprice=this.querySelector('td[name="total_price"]')
                    if(box.checked && !$(box).attr('disabled')){
                        total_price+=parseInt(tprice.innerHTML)
                    }

                })
                $("#total").text('$'+total_price)

            }
        </script>
        
        <script> //prvoder funtions
            
            function setProviders(){  
                callback=getFromApi('/product/providers')
                providers=callback["providers"]

                select=document.getElementById("selectProviders");

                if (select.length>1){
                    len=select.length
                    for(i=1;i<len;i++){
                        select.remove(1)
                    }
                }

                providers.forEach(p=>{
                    var option = document.createElement("option");
                    option.text=p["name"]
                    option.value=p["id"]
                    select.add(option,-1)
                })
            }

            
            function selectProvider(element){  //select provider and get products
                products=getProducts(element.value)
                
                $('#producttable tbody tr').each(function(){
                        $(this).remove()
                })
                var table = document.getElementById("producttable").querySelector('tbody');

                products.forEach(product => {
                    var row = table.insertRow(-1);
       
                    var name = row.insertCell(0);
                    var quantity = row.insertCell(1);
                    var price = row.insertCell(2);
                    var amount = row.insertCell(3);
                    var tags = row.insertCell(4);
                    var addbtn = row.insertCell(5);
                    var id = row.insertCell(6);

                    name.innerHTML = product['name'];
                    quantity.innerHTML = product['quantity'];
                    price.innerHTML = product['price'];
                    amount.innerHTML='<input type="number" name="amount" min="0" max='+product['quantity']+' value=0>';

                    tagsStr=""
                    product['tags'].forEach(tag=>{
                        tagsStr+="#"+tag["name"]+" "
                    })
                    tags.innerHTML=tagsStr

                    addbtn.innerHTML = '<button name="addToCart" class="btn btn-primary" onclick="addToCart(this)">add to cart</button>'
                 
                    $(id).hide();
                    $(id).attr('name','id')
                    $(id).attr('data-id',product['id'])
                    $(id).attr('data-edit','false')
                    
                });

            }
        </script>
        
        <script> //trade funtions
            function createTrade(){
                table=$('#carttable tbody tr')

                cartsId=[]
                
                $(table).each(function(){
                    box=this.querySelector('td input[name="select"]')
                    id=this.querySelector('td[name="id"]')
                    if(box.checked && !$(box).attr('disabled')){
                        cartsId.push(parseInt(id.dataset.id))
                    }
                })

                if(cartsId.length>0){
                    postToApi('/trade/create',{'carts':cartsId},()=>{alert('訂單成立  \n10分鐘後未完成付款將取消訂單');setTrades();})

                }
                else{
                    alert('you select nothing')
                }

                
            }

            function setTrades(){
                $("#tradetable tbody tr").each(function(){
                    $(this).remove()
                })
                table = document.getElementById("tradetable").querySelector('tbody');
                
                trades=getFromApi('trade')['trades']

                trades.forEach(trade=>{
                    var row = table.insertRow(-1);
    
                    var btns = row.insertCell(0);
                    var id = row.insertCell(1);
                    var detail = row.insertCell(2);
                    var total_price = row.insertCell(3);
                    var state = row.insertCell(4);

                    btns.innerHTML='<button name="pay" class="btn btn-outline-secondary" onclick="payTrade(this)" disabled>pay</button> \
                    <button name="ship" class="btn btn-outline-secondary"  onclick="ship(this)" disabled>ship</button> \
                    <button name="finish" class="btn btn-outline-secondary" onclick="finish(this)" disabled>finish</button>';

                    id.innerHTML=trade['id'];
                    id.setAttribute('name','id');
                    detail.innerHTML=trade['detail'];
                    total_price.innerHTML=trade['total_price'];
                    state.innerHTML=trade['state'];

                    paybtn=btns.querySelector('button[name="pay"]');
                    shipbtn=btns.querySelector('button[name="ship"]');
                    finishbtn=btns.querySelector('button[name="finish"]');

                    if(trade['state']=='start'){
                        paybtn.disabled=false
                        paybtn.classList.remove('btn-outline-secondary')
                        paybtn.classList.add('btn-primary')
              
                    }
                    else if(trade['state']=='paid'){
                        shipbtn.disabled=false
                        shipbtn.classList.remove('btn-outline-secondary')
                        shipbtn.classList.add('btn-primary')
                    }
                    else if(trade['state']=='shipping'){
                        finishbtn.disabled=false
                        finishbtn.classList.remove('btn-outline-secondary')
                        finishbtn.classList.add('btn-primary')
          
                    }

                })
            }
            
            function ship(element){
                parent=element.parentNode.parentNode
                id=parent.querySelector('td[name="id"]').innerHTML

                postToApi("/trade/ship",{"trade":parseInt(id)},()=>{setTrades()})

            }
            function finish(element){
                parent=element.parentNode.parentNode
                id=parent.querySelector('td[name="id"]').innerHTML

                postToApi("/trade/finish",{"trade":parseInt(id)},()=>{setTrades()})

            }

            function payTrade(element){
                parent=element.parentNode.parentNode
                id=parent.querySelector('td[name="id"]').innerHTML
   
                html=""
                $.ajax({ 
                    async:false,
                    url: "ecpay/pay" ,
                    type: "POST",
                    data:JSON.stringify({"trade":parseInt(id)}),
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        html=returnData
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )

                w=window.open();
                $(w.document.body).html(html);
            }
        
        </script>

        <script> //coupon funtions

            function setCoupons(){
                $("#couponstable tbody tr").each(function(){
                    $(this).remove()
                })
                table = document.getElementById("coupontable").querySelector('tbody');
                
                coupons=getFromApi('coupon')['coupons']

                coupons.forEach(coupon=>{
                    var row = table.insertRow(-1);
                    
                    var id = row.insertCell(0);
                    var name = row.insertCell(1);
                    var quantity = row.insertCell(2);
                    var description = row.insertCell(3);
                    var start = row.insertCell(4);
                    var end = row.insertCell(5);

                    id.innerHTML=coupon['id']
                    name.innerHTML=coupon['name']
                    quantity.innerHTML=coupon['quantity']
                    description.innerHTML=coupon['description']
                    start.innerHTML=coupon['start_time']
                    end.innerHTML=coupon['end_time']
                })
            }

            function createCoupon(){
                couponname=$('#newCoupon input[name="name"]').val()



                console.log()

     


            }

            function selectCouponProducts(){
                var ids=""
                $('#productModal tbody tr input').each(function(){

                    if(this.checked){
                        ids+=this.dataset.id+" "
                    }
                    
                })

                $('#selectedProducts').val(ids)

            }

        </script>
        
        <script>  //user funtions

            function login(){
                jdata={}
    
                jdata["email"]=$("#loginEmail").val()
                jdata["password"]=$("#loginPassword").val()
                $.ajax({    
                    url: "/user/login",
                    data: JSON.stringify(jdata),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        if (returnData['code']==0){
                            sessionStorage.setItem("login","true")
                            sessionStorage.setItem("user_id",returnData['user_id'])
                            sessionStorage.setItem("user_name",returnData['user_name'])
                            sessionStorage.setItem("page","main")
                            
                            refresh()
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
            }
            function signup(){
                jdata={}
                jdata["name"]=$("#signupName").val()
                jdata["email"]=$("#signupEmail").val()
                jdata["password"]=$("#signupPassword").val()
                jdata["confirmPassword"]=$("#signupCpassword").val()
                $.ajax({    
                    url: "/user/signup",
                    data: JSON.stringify(jdata),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        // console.log(returnData);
                        if (returnData['code']==0){
                            alert("Success,you can login now");
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
            }

            function logout(){
                $.ajax({    
                    url: "/user/logout",
                    type: "Get",
                    success: function(returnData){
                        // console.log(returnData);
                        if (returnData['code']==0){
                            sessionStorage.setItem("login","false");
                            sessionStorage.setItem("page","login")
                            
                            refresh();
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
            }

            function deleteUser(){
                callback=getFromApi("/user/delete")

                if(callback["code"]==0){
                    sessionStorage.clear()
                    alert("User deleted")
                    
                    refresh()

                }
                else{
                    alert("Fail,please try later")
                }
            }

            function signupPage(){
                sessionStorage.setItem("page","signup")
      
                refresh()
            }
            function loginPage(){
                sessionStorage.setItem("page","login")
            
                refresh()
            }
        </script>
    </body>
</html>