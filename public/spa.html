<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- CSS only -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    
    </head>
    <body>
    
        <main class=" container  ">
            

            <div id="login" class="row" >
                <div class="col-sm-3"></div>
                <div class="col-sm-6 text-center">
                    
                        <h1>Login</h1>
                        <div class="form-floating">
                            <input id="name" type="email" class="form-control" id="floatingInput" placeholder="name@example.com">
                            <label for="floatingInput">Name</label>
                        </div>
                        <div class="form-floating">
                            <input id="email" type="password" class="form-control" id="floatingPassword" placeholder="Password">
                            <label for="floatingPassword">Email</label>
                        </div>
                        
                        <button id="btnlogin" class="mt-2 w-50 btn btn-lg btn-primary" onclick="login()">login</button>
                        <button id="btnsignup" class="mt-2 w-50 btn btn-lg btn-primary" onclick="signup()">Signup</button>
                    
                    
                </div>
                <div class="col-sm-3"></div>
            </div>

            <div id="mainpage" class="container mt-3">
                <div class="row">
                    <h1 class="col-sm-8" id="hello">Hello,user</h1>
                    <button id="btnlogout" class="col-sm-4 btn btn-lg btn-primary" onclick="logout()">Logout</button>
                </div>
             
                <div class="mt-3">
                    <h4>my product</h4>
                    <table id="myproducttable" class="table table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Product name</th>
                                <th>price</th>
                                <th>amount</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <h4>Create product</h4>
                    <div class="input-group">
                        
                        <span class="input-group-text ">Product name</span>
                        <input type="text" name="name" class="form-control  ">
                    
                        <span class="input-group-text ">Price</span>
                        <input type="number" name="price" min="0" max="500" class="form-control ">
                        
                        <span class="input-group-text ">Quentity</span>
                        <input type="number"  name="quentity" min="0" max="500" class="form-control">

                        <button class="btn btn-info" onclick="createProduct(this)">create</button>
                    </div>
                </div>


            </div>
        </main>
        <script>
            function refresh(){
                
                if (sessionStorage.getItem("login")=="true"){
                    $("#login").css('display','none');
                    $("#mainpage").removeAttr('style');
                    $('#hello').text('Hello '+sessionStorage.getItem("user_name"))
                    $('#myproducttable tbody tr').each(function(){
                        $(this).remove()
                    })
                    // console.log($('#myproducttable tbody tr'))
                    myproduct()
                }
                else{
                    // islogin="false";
                    sessionStorage.setItem("login","false")
                    $("#mainpage").css('display','none');
                    $("#login").removeAttr('style');
                }
            }


        </script>


        <script>
            function myproduct(){
                products=getProducts(sessionStorage.getItem('user_id'))

                var table = document.getElementById("myproducttable").querySelector('tbody');
                products.forEach(element => {
                    var row = table.insertRow(-1);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    var cell4 = row.insertCell(3);
                    var cell5 = row.insertCell(4);
                    cell1.innerHTML = '<input type="text" name="name" readonly value='+ element['name']+ '>';
                    cell2.innerHTML = '<input type="number" name="price" min="0" max="500" readonly value='+element['price'] +'>';
                    cell3.innerHTML = '<input type="number" name="quantity" min="0" max="500" readonly value='+element['quentity'] +'>';
                    cell4.innerHTML = '<button name="save" onclick="saveProduct(this)">save</button>'+'<button name="edit" data-edit="false" onclick="editProduct(this)">edit</button>'
                 
                    $(cell5).hide();
                    $(cell5).attr('name','id')
                    $(cell5).attr('data-id',element['id'])
                    
                });

            }
            function getChild(element){
                parent=element.parentNode.parentNode
                pname=parent.querySelector('input[name="name"]') //pname product name
                quentity= parent.querySelector('input[name="quantity"]')
                price=parent.querySelector('input[name="price"]')
                id=parent.querySelector('td[name="id"]')
                return [pname,quentity,price,id]
            }
            function saveProduct(element){

                [pname,quentity,price,id]=getChild(element) //pname product name

                jdata={}
                product={}
                product["id"]=id.dataset.id
                product["name"]=pname.value
                product["quentity"]=quentity.value
                product["price"]=price.value

                jdata['products']=[product]
                $.ajax({    
                    url: "/product/updateProducts",
                    data: JSON.stringify(jdata),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        if (returnData['code']==0){
                            alert("Saved")
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
                
            }

            function editProduct(element){
                [pname,quentity,price,id]=getChild(element) //pname product name
                if (element.dataset.edit=='false'){
       
                    pname.removeAttribute('readonly')
                    quentity.removeAttribute('readonly')
                    price.removeAttribute('readonly')
                  
                    element.setAttribute('data-edit','true')
                }
                else{
                    pname.setAttribute('readonly',true)
                    quentity.setAttribute('readonly',true)
                    price.setAttribute('readonly',true)

                    element.setAttribute('data-edit','false')
                }
            }

            function getProducts(id){
                var products
                $.ajax({ 
                    async:false,
                    url: "/product/products?id="+id,
                    type: "GET",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        if (returnData['code']==0){
                            products=returnData['products'];
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
                return products
            }

            function createProduct(element){
                parent=element.parentNode
                pname=parent.querySelector('input[name="name"]').value //product name
                price=parent.querySelector('input[name="price"]').value 
                quentity=parent.querySelector('input[name="quentity"]').value

                jdata={}
                product={}
                product["name"]=pname
                product["quentity"]=quentity
                product["price"]=price

                jdata['products']=[product]
                $.ajax({    
                    url: "/product/addProducts",
                    data: JSON.stringify(jdata),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        if (returnData['code']==0){
                            alert("Saved")
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )

                
                
            }
        </script>
        
        
        <script>  
            // sessionStorage.setItem("login","true");      ///  
            refresh();

            function login(){
                jdata={}
                jdata["name"]=$("#name").val()
                $.ajax({    
                    url: "/user/login",
                    data: JSON.stringify(jdata),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        if (returnData['code']==0){
                            sessionStorage.setItem("login","true")
                            sessionStorage.setItem("user_id",returnData['user_id'])
                            sessionStorage.setItem("user_name",returnData['user_name'])
                            refresh()
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
            }
            function signup(){
                jdata={}
                jdata["name"]=$("#name").val()
                jdata["email"]=$("#email").val()
                $.ajax({    
                    url: "/user/signup",
                    data: JSON.stringify(jdata),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: function(returnData){
                        // console.log(returnData);
                        if (returnData['code']==0){
                            alert("Success");
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
            }

            function logout(){
                $.ajax({    
                    url: "/user/logout",
                    type: "Get",

                    success: function(returnData){
                        // console.log(returnData);
                        if (returnData['code']==0){
                            sessionStorage.setItem("login","false");
                            refresh();
                        }
                        else{
                            alert(returnData['msg']);
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        console.log(xhr.status);
                        console.log(thrownError);
                    }}
                )
            }

        </script>
    </body>
</html>